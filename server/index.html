<!DOCTYPE html>
<body>
  <pre id="output"></pre>

  <canvas id="canvas" width="500" height="500" style="border: 1px solid black"></canvas>

  <script>
    const MESSAGE_TYPES = {
      UNSPECIFIED: 0,
      UPDATE_PLAYER_DATA: 1,
      UPDATE_GAME_STATE: 2,
      SET_CLIENT_ID: 3,
      DISCONNECT_CLIENT: 4,
      CLIENT_ADDED: 5,
    };

    const MESSAGE_TYPES_VALUES = {
      UNSPECIFIED: "UNSPECIFIED",
      UPDATE_PLAYER_DATA: "UPDATE_PLAYER_DATA",
      UPDATE_GAME_STATE: "UPDATE_GAME_STATE",
      SET_CLIENT_ID: "SET_CLIENT_ID",
      DISCONNECT_CLIENT: "DISCONNECT_CLIENT",
      CLIENT_ADDED: "CLIENT_ADDED",
    };

    function getColorCode() {
      const makeColorCode = "0123456789ABCDEF";
      let code = "#";
      for (let count = 0; count < 6; count++) {
        code = code + makeColorCode[Math.floor(Math.random() * 16)];
      }
      return code;
    }

    let clientId = null;
    let state = null;
    const socket = new WebSocket("ws://localhost:8080/wsb");
    const mycolor = getColorCode();

    socket.onopen = function () {
      output.innerHTML += "Status: Connected\n";

      const msg = JSON.stringify({
        type: MESSAGE_TYPES.UPDATE_PLAYER_DATA,
        data: JSON.stringify({
          name: "foobar",
          x: 0,
          y: 0,
          color: mycolor,
        }),
      });

      sendBinary(msg);
    };

    const setState = (data) => {
      const msg = JSON.parse(data);

      switch (msg.type) {
        case MESSAGE_TYPES_VALUES.SET_CLIENT_ID:
          clientId = msg.data;

          break;
        case MESSAGE_TYPES_VALUES.UPDATE_GAME_STATE:
          state = JSON.parse(msg.data);

          break;
        default:
          break;
      }
    };

    socket.onmessage = function (e) {
      if (e.data instanceof Blob) {
        e.data.text().then(setState);
      } else {
        setState(e.data);
      }
    };

    const getState = () => {
      return state;
    };

    const getClientId = () => {
      return clientId;
    };

    const sendBinary = (msg) => {
      const bytes = new TextEncoder().encode(msg);
      const blob = new Blob([bytes]);

      socket.send(blob);
    };

    const updateMyPosition = (pos) => {
      const msg = JSON.stringify({
        type: MESSAGE_TYPES.UPDATE_PLAYER_DATA,
        data: JSON.stringify({
          name: "foobar",
          x: pos.x,
          y: pos.y,
          color: mycolor,
        }),
      });

      sendBinary(msg);
    };

    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");

    canvas.addEventListener(
      "mousemove",
      (e) => {
        console.log(e.clientX, e.clientY, e.offsetX, e.offsetY);
        const pos = {
          x: e.offsetX,
          y: e.offsetY,
        };

        updateMyPosition(pos);
      },
      false
    );

    const drawPlayer = (ctx, player) => {
      ctx.fillStyle = player?.color ?? "#FFF";
      ctx.fillRect(player?.x ?? 0, player?.y ?? 0, 10, 10);
    };

    const drawMe = (ctx) => {
      const me = state?.players?.[clientId];
      drawPlayer(ctx, me);
    };

    const drawOthers = (ctx) => {
      Object.keys(state?.players ?? {}).forEach((id) => {
        if (id !== clientId) {
          drawPlayer(ctx, state?.players[id]);
        }
      });
    };

    const draw = (ctx) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMe(ctx);
      drawOthers(ctx);
    };

    setInterval(() => draw(context), 16);
  </script>
</body>
